<%- include('./partials/sidebar.ejs') %>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPD Queue Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-patient { margin-bottom: 1rem; }
        .badge-status { font-size: 0.9em; }
        .search-bar { margin-bottom: 1.5rem; }
        .dashboard-card { min-width: 180px; }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <!-- Dashboard Cards -->
    <div class="row mb-4">
        <div class="col dashboard-card">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <div class="fs-4 fw-bold"><%= patients.length %></div>
                    <div>Total Patients</div>
                </div>
            </div>
        </div>
        <div class="col dashboard-card">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <div class="fs-4 fw-bold text-warning">
                        <%= patients.filter(p => p.status === 'waiting').length %>
                    </div>
                    <div>Waiting</div>
                </div>
            </div>
        </div>
        <div class="col dashboard-card">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <div class="fs-4 fw-bold text-primary">
                        <%= patients.filter(p => p.status === 'in-progress').length %>
                    </div>
                    <div>In Progress</div>
                </div>
            </div>
        </div>
        <div class="col dashboard-card">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <div class="fs-4 fw-bold text-success">
                        <%= patients.filter(p => p.status === 'completed').length %>
                    </div>
                    <div>Completed</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Patient Button -->
    <div class="d-flex justify-content-end mb-3">
        <a href="/admin/opd/new" class="btn btn-success">+ Add Patient</a>
    </div>

    <!-- Search and Filters -->
    <form method="GET" action="/admin/opd" class="row align-items-center search-bar">
        <!-- Search Bar -->
        <div class="col-md-6 mb-2 mb-md-0">
            <input type="text" class="form-control" name="search" placeholder="Search by name or token ID..." value="<%= searchTerm %>">
        </div>
        <!-- Department Filter -->
        <div class="col-md-3 mb-2 mb-md-0">
            <select class="form-select" name="department">
                <option value="">All Departments</option>
                <% departments.forEach(department => { %>
                    <option value="<%= department %>" <%= department === selectedDepartment ? 'selected' : '' %>><%= department %></option>
                <% }) %>
            </select>
        </div>
        <!-- Status Filter -->
        <div class="col-md-3">
            <select class="form-select" name="status">
                <option value="">All Status</option>
                <option value="waiting" <%= status === 'waiting' ? 'selected' : '' %>>Waiting</option>
                <option value="in-progress" <%= status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                <option value="completed" <%= status === 'completed' ? 'selected' : '' %>>Completed</option>
            </select>
        </div>
        <!-- Apply Filters Button -->
        <div class="col-md-3 d-flex justify-content-start">
            <button type="submit" class="btn btn-outline-primary">Apply Filters</button>
        </div>
    </form>

    <!-- Patient Cards -->
    <% patients.forEach(patient => { %>
        <div class="card card-patient shadow-sm">
            <div class="card-body d-flex align-items-center">
                <div class="me-3">
                    <span class="bg-success bg-opacity-10 rounded-circle p-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#198754" class="bi bi-person" viewBox="0 0 16 16">
                          <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm4-3a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/>
                          <path d="M2 13s-1 0-1-1 1-4 7-4 7 3 7 4-1 1-1 1H2zm13-1c0-1-4-4-7-4s-7 3-7 4c0 .5.5 1 1 1h12c.5 0 1-.5 1-1z"/>
                        </svg>
                    </span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold fs-5"><%= patient.name %> </div>
                    <div class="text-muted mb-1">
                        <span class="me-3"><i class="bi bi-telephone"></i> <%= patient.phone %></span>
                        <span><i class="bi bi-calendar"></i> <%= patient.appointmentTime %></span>
                    </div>
                    <div class="row">
                        <div class="col-auto">
                            <div class="small text-secondary">Department</div>
                            <div class="fw-semibold"><%= patient.department %></div>
                        </div>
                        <div class="col-auto">
                            <div class="small text-secondary">Position</div>
                            <div class="fw-semibold">#<%= patient.position %></div>
                        </div>
                        <div class="col-auto">
                            <div class="small text-secondary">Wait Time</div>
                            <div class="fw-semibold"><%= patient.waitTime %></div>
                        </div>
                        <div class="col-auto">
                            <span class="badge badge-status 
                                <% if(patient.status === 'waiting'){ %> bg-warning text-dark <% } %>
                                <% if(patient.status === 'in-progress'){ %> bg-primary <% } %>
                                <% if(patient.status === 'completed'){ %> bg-success <% } %>
                            ">
                                <%= patient.status %>
                            </span>
                            <span class="badge badge-status 
                                <% if(patient.priority === 'urgent'){ %> bg-danger <% } else { %> bg-secondary <% } %>
                            ">
                                <%= patient.priority %>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="ms-3 text-end">
                    <% if(patient.status === 'waiting' || patient.status === 'in-progress'){ %>
                        <!-- <button class="btn btn-outline-success btn-sm mb-2">Call Next</button><br> -->
                    <% } %>
                    <a href="/admin/opd/<%= patient.id %>/edit" class="btn btn-outline-primary btn-sm mb-2">Edit</a><br>
                    <form action="/admin/opd/<%= patient.id %>/delete" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    <% }) %>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</body>
</html>
